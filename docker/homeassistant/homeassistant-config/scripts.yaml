alias: dump configuration
sequence:
  - alias: set variables
    variables:
      scenes_by_friendly_name_getter: >
        {% raw %} {{ scenes_by_friendly_name[trigger.to_state.state] }} {% endraw %}
  - service: notify.configuration_notifier
    data:
      message: |
        # BEGIN AUTO GENERATED CONFIG
        # GENERATED AT: {{ utcnow().isoformat() }}

        {% for area in areas() -%}
        {% if not area_entities(area) | expand | selectattr('domain', 'eq', 'scene') | list -%}
        # {{ area }} does not have any scenes
        {% continue %}
        {%- endif %}

        # AUTO GENERATED CONFIG FOR {{ area }}: 
        input_select:
          autogen_{{ area }}_scenes_input_select_dropdown:
            name: autogen {{ area }} scenes input select
            options:
              {%- for item in area_entities(area) | expand | selectattr('domain', 'eq', 'scene')| list %}
              - {{ item.name }}
              {%- endfor %}
            initial: {{ area_entities(area) | expand | selectattr('domain', 'eq', 'scene')| first | attr('name') }}
            
        automation {{ area }}:
          - id: autogen_{{ area }}_scene_change_automation
            alias: autogen_change_{{ area }}_scenes
            description: (autogen) change the {{ area }} scenes from the dropdown
            trigger:
              - platform: state
                entity_id:
                  - input_select.{{ area }}_scenes_input_select_dropdown
            condition: []
            mode: queued
            action:
              - service: scene.turn_on
                target:
                  entity_id: >
                    {{ '{% raw %}' }} {{ scenes_by_friendly_name_getter }} {{ '{% endraw %}' }}
            variables:
              scenes_by_friendly_name:
                {%- for item in area_entities(area) | expand | selectattr('domain', 'eq', 'scene')| list %}
                  {{ item.name }}: {{ item.entity_id }}
                {%- endfor %} 
        # END AUTO GENERATED CONFIG
mode: single
icon: mdi:cog

populate_area_scene_dropdown:
  alias: populate_area_scene_dropdown
  fields:
    area_name:
      name: area name
      description: the area that the scenes belong to
      required: true
      selector:
        area:
    dropdown_entity_id:
      name: dropdown entity id
      description: the entity id of the dropdown to attach the scenes to
      required: true
      selector:
        entity:
          filter:
            - domain: input_select
  sequence:
    - service: input_select.set_options
      data:
        options: >
          {{ area_entities(area_name)
          | expand
          | selectattr('domain', 'eq', 'scene')
          | map(attribute='name')
          | list}}
      target:
        entity_id: "{{ dropdown_entity_id }}"
  mode: single
  icon: mdi:form-dropdown
